# Wukong-Huahua
## Contents

[查看中文](./README.md)

- [Wukong-Huahua Model](#wukong-huahua-model)
- [Environment Requirements](#environment-requirements)
- [Quick Start](#quick-start)
  - [Prepare Checkpoint](#prepare-checkpoint)
  - [Text to Image Generation](#text-to-image-generation)
  - [Fine-tuning](#fine-tuning)
  - [Demos](#demos)

## Wukong-Huahua Model

Wukong-Huahua is a diffusion-based model that perfoms text-to-image task in Chinese, which was developed by the **Huawei Noah's Ark Lab** in cooperation with the **Distributed & Parallel Software Lab** and **Ascend Product Develop Unit**. It was trained on [Wukong dataset](https://wukong-dataset.github.io/wukong-dataset/)  and used [MindSpore](https://www.mindspore.cn/en) + Ascend, a software and hardware solution to implement. Welcome to try Wukong-Huahua by [Our Online Platform](https://xihe.mindspore.cn/modelzoo/wukong).

## Environment Requirements

1. **Ascend** Software + Hardware Solution (Driver + Firmware + CANN)
	
	Go to [Ascend website](<https://www.hiascend.com/software/cann/commercial>). Follow the instructions to download and install.
2. AI Framework - **Mindspore** == 1.9

	  Go to [MindSpore website](https://www.mindspore.cn/en "MindSpore")  1.9. Follow the instructions to install.
	 
	  If you need more help of MindSpore, please check
	  - [MindSpore Tutorial](https://www.mindspore.cn/tutorials/en/master/index.html)
	  - [MindSpore Python API](https://www.mindspore.cn/docs/en/master/index.htmll)		
	  
3. Third party dependency
   ```python
   pip install -r requirements.txt
   ```


## Quick Start

### Prepare Checkpoint

Download Wukong-Huahua pretrained checkpoint [wukong-huahua-ms.ckpt](https://download.mindspore.cn/toolkits/minddiffusion/wukong-huahua/wukong-huahua-ms.ckpt) and place it under wukong-huahua/models/ folder.

For fine tune task , we provide example datasets to show the format, please download [here](https://opt-release.obs.cn-central-221.ovaijisuan.com/wukonghuahua/dataset.tar.gz).

### Text to Image Generation

To generate images according to input text, run txt2img.py or simply run infer.sh with default argumemts.

```shell
python txt2img.py --prompt [input text] --ckpt_path [ckpt_path] --ckpt_name [ckpt_name] \
--H [image_height] --W [image_width] --output_path [image save folder] \
--n_samples [number of images to generate]
```
or
```shell
bash scripts/infer.sh
```

Generating higher resolution requires more memory. For Ascend 910 chip, we can generate 2 1024x768 images or 16 512 x 512 images at same time.

### Fine-tuning

- Single card fine-tune:

modify the related configs in scripts/run_train.sh

```
bash scripts/run_train.sh
```

- Multi-card fine-tune:

modify the related configs in scripts/run_train_parallel.sh

```
bash scripts/run_train_parallel.sh [DEVICE_NUM] [VISIABLE_DEVICES(0,1,2,3,4,5,6,7)] [RANK_TABLE_FILE]
```

### Demos

Below are some of the images generated by our wukong-huahua model and corresponding `[input text]`

```
城市夜景 赛博朋克 格雷格·鲁特科夫斯基
```

![城市夜景 赛博朋克 格雷格·鲁特科夫斯基](demo/城市夜景%20赛博朋克%20格雷格·鲁特科夫斯基.png)

```
莫奈 撑阳伞的女人 月亮 梦幻
```

![莫奈 撑阳伞的女人 月亮 梦幻](demo/莫奈%20撑阳伞的女人%20月亮%20梦幻.png)

```
海上日出时候的奔跑者
```

![海上日出时候的奔跑者](demo/海上日出时候的奔跑者.png)

```
诺亚方舟在世界末日起航 科幻插画
```

![诺亚方舟在世界末日起航 科幻插画](demo/诺亚方舟在世界末日起航%20科幻插画.png)

```
时空 黑洞 辐射
```

![时空 黑洞 辐射](demo/时空%20黑洞%20辐射.png)

```
乡村 田野 屏保
```

![乡村 田野 屏保](demo/乡村%20田野%20屏保.png)

```
来自深渊 风景 绘画 写实风格
```

![来自深渊 风景 绘画 写实风格](demo/来自深渊%20风景%20绘画%20写实风格.png)
